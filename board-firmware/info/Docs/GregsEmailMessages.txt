--------------
Greg 9/14/2009
--------------
I have a few questions concerning the differential pressure curves:

1,   What are the coefficients entered in machine setup?  They look like cylinder bore area and bore area minus the rod area?

2,   How is the pressure differential calculated from the coefficients?  What formula is used?

3,    What's the formula for calculating metal pressure?  Do you take into account the differential pressure before calculating metal pressure?

This will become important if we get the order from Madison Kipp we've been working on lately.  They have 5 or 6 Buhler SC machines.  Buhler controls pressure by placing full system pressure on the head side of the cylinder and modulating pressure on the rod side, which applies a counterforce on the cylinder.  By increasing or decreasing the counterforce, they can increase or decrease the metal pressure.  They don't use an intensifier like most US made machines.

What's even more interesting, they control both the shot and the intensification with one valve.  They like the valve but are looking to replace the Buhler controls.

I was wondering if it would be easier just to enter the shot cylinder bore and rod diameters in the machine setup and eliminate the "Differential Curve Type" and the coefficients?   With the diameters you could calculate the bore and rod areas and then calculate:

Annular area = bore area - rod area.
Multiplier ratio of the shot cylinder = bore area  / annular area.
Plunger ratio = bore area / plunger area.
Differential pressure = head pressure - (rod pressure / multiplier ratio).
Metal pressure = differential pressure * plunger ratio.

If somebody wants to plot the differential pressure or the metal pressure, you have what you need to do it, while making the machine setup easy.

In order for me to control differential pressure, we'd have to setup another variable on the FT2 board which would be the multiplier ratio of the shot cylinder.  With that, I could calculate differential pressure on the fly and then control the differential pressure.

If we get the order from Madison Kipp, we may have to add another check box in the pressure control setup screen to select differential pressure control, which would only be active if both the hardware closed loop and total open loop boxes were unchecked.  Otherwise it would be grayed out.

-------------
Jay 9/14/2009
-------------

You are correct in your assumptions about the coefficients.

The two coefficients. Ch and Cr are just the movable areas that the head and rod pressures push against.

Metal pressure and differential pressure are really just the same thing.

Differential pressure was originally added for UBE machines and was defined for post impact only.

     Pressure    Coefficient
Head     Ph            Ch
Rod      Pr            Cr

The coefficients are calculated from the geometry of the UBE machine. Given the following:

A1 = area of shot cylinder
A2 = area of decel tube
A3 = area of rod

Then the coefficients are calculated as follows:

Ch    = A1 - A3
Cr    = A2 + A3 - A1

Differential pressure = ( Ch*Ph + Cr*Pr ) / plunger area.

Later we made it so you could use the combined pressure for non-UBE machines and pre-impact as well as post-impact and called it metal pressure. For this you calculate the coefficients as

Ch = Area of Shot Cylinder
Cr = -( Area of Shot Cylinder - Area of the Rod )

It probably would be more straightforward to just set up an area on the machine setup to define the areas as you suggest. This would have to include decel tube area as well, as we still have people using differential pressure on UBE machines. The problem would be making the change to existing installations. The only way I can think of to do this is to allow ether the old way or new way, which increases the complexity of the program (doesn't everything?).

--------------
Greg 9/15/2009
--------------

Thanks for the info.

That all makes sense.  The only thing that I would say is that for non-Ube machines, metal pressure and differential pressure maybe should be two separate entities.

Your formula for differential pressure (Differential pressure = ( Ch*Ph + Cr*Pr ) / plunger area) is really metal pressure, therefore:
Metal pressure = ( Ch*Ph + Cr*Pr ) / plunger area.
Differential pressure = ( Ch*Ph + Cr*Pr ) / Ch.

On the Buhler machines, we'll be controlling differential pressure, therefore we'll want to plot true differential pressure if the user selects a differential plot.  If he selects metal pressure, that's what will plot.  You could also plot both at the same time.

If we get this order from Madison Kipp, perhaps we can revisit this and consider making some minor changes.  I'll need to define a new variable and ask you to set it to Ch / |Cr| * 100 which will be the multiplier ratio of the cylinder X 100.  I probably should also get the plunger ratio ((Ch / plunger area )* 100) as well.  That way, I'll be able to calculate differential pressure and metal pressure as well.

---------------
Greg 11/23/2009
---------------

Attached are V7.50 flash files for both the Apex and Cyclone boards as well as updated documents.  The following changes have been made:

1,    Added an 8 bit quadrature divider circuit to allow dividing by 255.  Variable 314, the configuration word #2 is used to set the divisor.  Bits 0-3 are the existing lower 4 bits of the divisor.  Bits 24-27 are the upper 4 bits and have been added.  These bits are set to zero on existing versions of firmware so there should not be any compatibility issues using V7.50 firmware with existing True-Trak software.

2,  Made the Apex version of V7.50 firmware completely functionally compatible with the Cyclone II version.  Both versions are compiled from the same source code.  They work exactly the same in every way.  Whatever the Cyclone II board does, the Apex version will function exactly the same way.

3,    Both the Apex and CycloneII versions requiring upgrading to version 16 chip configuration file.  The boards must have their chip configuration file changed to version 16 before V7.50 firmware will function.

4,    Even though the two boards are functionally equivalent, the flash files themselves are completely different and are not compatible between the boards (same as before).  Cyclone II flash files begin with a "cyc" prefix and Apex flash files begin with an "emc" prefix, exactly as before.
5,   When updating a Cyclone II board, only the cyc_7_50.flash and cyc_16010201.flash files need to be loaded.  The other flash files haven't changed and don't need to be updated.

6,   A master programming file is included for the Cyclone II version.  This file is CycloneII_7_50_192_169_254_99.pof and can be blasted directly to flash using the USBlaster cable.  See the Initial FTII config_cycloneII document for more details.  This makes programming Cyclone II boards much easier.  This cannot be done on Apex boards since they do not have a JTAG interface tied directly to the flash memory.

7,   When updating an Apex board to V7.50 firmware, the following files have to be loaded:    emc_16010200.hexout.flash
   emc_16010200.hexout.0x1c0000.flash
   emc_7_50.flash
   ad_loop19.flash.

   The only flash file that has not changed is revB_ad_loop18.flash

8,   Before updating an existing Apex board, the control program and variables in flash have to be erased.  The following command will erase these:  e108000<CR>  Then the connection has to be reset from within the True-Trak program to reload the variables and control program.

9,   The Apex version of 7.50 firmware is a major change.  I don't expect any problems since the code is already proven on the Cyclone II board.  It runs exactly like a Cyclone II board here in my testing.  However be careful when doing the first one in the field to make sure everything runs as expected.  Perhaps an Apex board can be loaded with 7.50 and run on the shot end.

10,   The Realtime screen will display the firmware version as 7_50 for both the Cyclone II and Apex versions of the board.  You won't be able to tell which board is present just by looking at the Realtime screen.  Execute an OV command to see which board is present.  As far as the True-Trak program is concerned, it shouldn't care which board is present.  If the firmware is 7.50 or greater, both boards will function identically.
11,   I'd like to try and not make any further updates to V6 firmware on the Apex board.  All future changes to Apex firmware should be V7.51 and later and occur in unison with Cyclone II updates.

Let me know if you would like to see something changed.

-------------------
Jay 11/24/2009 1:14
-------------------

I normally include all of the update files in case people are upgrading from an earlier release. Is this ok? Can the board be updated from an ealier flash or does it have to be at Version 6_12?

Apex 7_50 Flash Proceedure.

1. Send E108000 command to erase the current control program  2. Upload the entire control program to the board as though the operator choose "Reset" from the menu.
3. Upload the "version 16 chip configuration file".    I assume this means emc_16010200.hexout.flash and emc_16010200.hexout.0x1c0000.flash. Is that true?
4. Do I have to have the operator reboot now?
5. Upload the remaining files:
  ad_loop19.flash
  emc_7_50.flash
  revB_ad_loop18.flash
6. Prompt the operator to reboot.

Clyclone II 7_50 Flash Proceedure

1. Upload cyc_chip_16010201.flash
2. Reboot using the RB command?
3. Upload the rest of the files
  cyc_7_50.flash
  cyc_ad_loop19.flash
  cyc_revB_ad_loop18.flash
  germs_monitor_epcs1.flash
4. Reboot using the RB command.

When I update from V7.06 to V7.07 of my program I will look at the machine set up to see if this is a 100 pitch machine. If it is then I will set the new Quadrature Divisor to 5. Otherwise I will set it to one.

Are there any installations that have edited the control_all.txt file and changed V314 to have something other than the default value of 1? If so I will read that file, if this is not a 100 pitch machine, and use the value in the control_all.txt file.

--------------------
Greg 11/24/2009 2:44
--------------------

A board can be updated from any version.  The board will not execute what's being updated until it is reset.  Updating is simply changing the flash and that can be done on any previous version.

I've modified the flash procedures here:

Apex 7_50 Flash Procedure:

1,   Erase control program and variables e108000<CR>
2,   Upload all flash files at the same time:
         emc_16010200.hexout.flash
         emc_16010200.hexout.0x1c0000.flash
         emc_7_50.flash
         ad_loop19.flash
         revB_ad_loop18.flash  (This file hasn't changed however it can be reloaded again if desired).
3,   Reboot.  Some newer Apex boards may execute the RB command.  Most will probably have to be manually rebooted.
4,   Attempt to connect.  If successful, then reset connection to update the control program and variables.

You may have to go back and forth between exiting the True-Trak program, connecting and resetting several time to get the board to come alive the first time after updating to 7.50 firmware.  Once it does, there should not be any further difficulty.

Clyclone II 7_50 Flash Procedure:

1,   Unprotect flash with the e(<CR> command
2,   Upload all flash files at the same time:
      cyc_chip_16010201.flash
      cyc_7_50.flash
      These files haven't changed but can be reloaded again if desired:
          cyc_ad_loop19.flash
          cyc_revB_ad_loop18.flash
          germs_monitor_epcs1.flash
3. Reboot using the RB command.

Madison Kipp may have manually edited V314, that's the only one I'm aware of.

--------------------
Greg 12/07/2009 1:45
--------------------

I believe the reason I changed the Apex version to 7.50 is that in the shot control setup screen, the derivative and and integral entries were not displayed if the firmware was a V6.xx Apex version.  Perhaps there are some other places where you're doing something different for the Cyclone II board vs. the Apex board as well.

Since Apex version V6.50 we talked about this morning will be functionally compatible with CycloneII V7.50, are you able to change your code such that if the firmware is an Apex version 6.50 or later, functionally, you'll treat it the same as if it were a Cyclone II version?

-------------------
Jay 12/07/2009 2:46
-------------------

Good point.

Once the Apex board has been upgraded do I need to send an e(<cr> before updating it from then on?

Will the RB<cr> command reboot the Apex board once it is at 7_50?

If these are true then the only thing I have to do is change the upload program to get the response to OV before doing anything so that I know if it is an Apex or Cyclone. Then I will be able to check to see that the operator is not sending the wrong file set to the board.

No other programs will know the difference in either case so I guess you might as well use 7_50 for both boards.

---------------------
Greg 12/07/2009  3:37
---------------------

Even though the boards are functionally equivalent as far as monitoring and control are concerned, the flash hardware is quite a bit different.  The e( unprotect command is only valid on the Cyclone II board.  The flash on the Apex board does not have the ability to be protected and unprotected.  If you send an unprotect command to an Apex board, you'll probably get an "? # unknown command"  response, but otherwise shouldn't hurt anything.

The ability to reboot Apex boards with the RB command is not determined by the firmware or the chip configuration flash file.  There is another small PLD on the Apex board that handles the boot process.  That PLD has to have been programmed with the latest version in order for the RB command to work.  Unfortunately, there's no way to find out what version that chip has been programmed with.  You can't get that information by sending a command to the board.  RB either works or it doesn't.  The change to implement the RB command was made in January, 2005.  Most boards made in mid 2005 and later will probably execute the RB command although I don't know exactly when that change would have been made on production boards.

